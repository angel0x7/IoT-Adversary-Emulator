/*
 * CODE CLIENT : Arduino MKR WiFi 1010
 * Rôle : Se connecte au Wi-Fi de l'ESP32 et envoie des données
 */

#include <SPI.h>
#include <WiFiNINA.h> // Librairie spécifique au MKR 1010

// ================= CONFIGURATION RÉSEAU (Cible l'ESP32) =================
char ssid[] = "Reseau_OT_Segment";  // Doit correspondre au code de l'ESP32
char pass[] = "12345678";           // Doit correspondre au code de l'ESP32

// L'adresse IP de l'ESP32 (Gateway) définie dans ton code ESP32
IPAddress serverIP(192, 168, 2, 1); 
int serverPort = 8080;

WiFiClient client;
int status = WL_IDLE_STATUS;

// ================= SETUP =================
void setup() {
  Serial.begin(115200);
  
  // Vérification du module Wi-Fi
  if (WiFi.status() == WL_NO_MODULE) {
    Serial.println("Module Wi-Fi non détecté !");
    while (true);
  }

  // Tentative de connexion au réseau de l'ESP32
  while (status != WL_CONNECTED) {
    Serial.print("Connexion au réseau OT : ");
    Serial.println(ssid);
    status = WiFi.begin(ssid, pass);
    delay(5000); // Attendre 5 sec avant de réessayer
  }

  Serial.println("\n--- CONNECTÉ AU RÉSEAU OT ---");
  printWifiStatus();
}

// ================= LOOP =================
void loop() {
  
  // 1. Simuler des données (Ex: Température / Humidité)
  // On utilise le format JSON car c'est standard pour MQTT ensuite
  float temperature = random(200, 300) / 10.0; // Génère 20.0 à 30.0
  int humidite = random(40, 70);
  
  // Création du message
  String message = "{\"device\": \"MKR1010\", \"temp\": " + String(temperature) + ", \"hum\": " + String(humidite) + "}";

  Serial.println("\n[MKR] Tentative d'envoi vers ESP32...");

  // 2. Connexion au serveur TCP (L'ESP32)
  if (client.connect(serverIP, serverPort)) {
    Serial.println("[MKR] Connecté au serveur !");

    // 3. Envoi des données (Important : println pour le '\n' attendu par l'ESP32)
    client.println(message);
    Serial.println("[MKR] Données envoyées : " + message);

    // 4. Attente de la réponse (ACK)
    // On attend max 2 secondes pour une réponse
    unsigned long timeout = millis();
    while (client.connected() && !client.available()) {
      if (millis() - timeout > 2000) {
        Serial.println("[MKR] Timeout : Pas de réponse de l'ESP32.");
        break;
      }
    }

    // 5. Lecture de la réponse
    while (client.available()) {
      String line = client.readStringUntil('\n');
      line.trim();
      Serial.print("[MKR] Réponse reçue : ");
      Serial.println(line);

      if (line == "ACK_OK") {
        Serial.println(" -> Succès : Données relayées au MQTT !");
      } else if (line == "ACK_FAIL") {
        Serial.println(" -> Erreur : L'ESP32 n'a pas pu envoyer au MQTT.");
      }
    }

    // 6. Fermeture de la connexion
    client.stop();
    Serial.println("[MKR] Connexion fermée.");

  } else {
    // Si la connexion à l'IP 192.168.2.1 échoue
    Serial.println("[MKR] Échec de connexion à l'ESP32.");
  }

  // Attendre 5 secondes avant le prochain envoi
  delay(5000);
}

// Fonction utilitaire pour afficher les infos réseau
void printWifiStatus() {
  Serial.print("SSID: ");
  Serial.println(WiFi.SSID());
  IPAddress ip = WiFi.localIP();
  Serial.print("IP Address: ");
  Serial.println(ip);
}
